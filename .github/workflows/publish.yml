name: Auto Publish to npm

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
      - 'images/**'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/FUNDING.yml'
      - 'LICENSE'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      bump:
        description: 'Version bump type'
        required: false
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

concurrency:
  group: npm-publish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ‚îÄ‚îÄ‚îÄ Job 1: Audit, Lint & Build Verification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  check:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: |
          echo "## üîí Security Audit" >> $GITHUB_STEP_SUMMARY
          CRITICAL=$(npm audit --json --omit=dev 2>/dev/null | node -e "
            let d='';process.stdin.on('data',c=>d+=c);process.stdin.on('end',()=>{
              try{const a=JSON.parse(d);const v=a.metadata?.vulnerabilities||{};
              const c=(v.critical||0)+(v.high||0);
              console.log(String(c));
              if(c>0)process.exitCode=0}
              catch(e){console.log('0')}
            })" 2>/dev/null || echo "0")
          echo "Critical+High vulnerabilities: $CRITICAL"
          if [ "$CRITICAL" != "0" ] && [ "$CRITICAL" != "" ]; then
            echo "‚ùå Found $CRITICAL critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "‚úÖ No critical/high vulnerabilities" >> $GITHUB_STEP_SUMMARY

      - name: Validate package.json
        run: |
          node -e "
            const pkg = require('./package.json');
            const required = ['name','version','main','bin','license','repository','engines'];
            const missing = required.filter(k => !pkg[k]);
            if (missing.length) { console.error('‚ùå Missing: ' + missing.join(', ')); process.exit(1); }
            console.log('‚úÖ package.json valid: ' + pkg.name + '@' + pkg.version);
          "

      - name: Syntax check core files
        run: |
          for f in src/index.js src/server.js src/config.js src/constants.js bin/cli.js; do
            node --input-type=module --check < "$f" && echo "‚úÖ $f" || { echo "‚ùå $f"; exit 1; }
          done

      - name: Verify provider files
        run: |
          node -e "
            const fs = require('fs');
            const files = fs.readdirSync('./src/providers').filter(f => f.endsWith('.js'));
            if (files.length === 0) { console.error('‚ùå No providers found'); process.exit(1); }
            console.log('‚úÖ Found ' + files.length + ' providers: ' + files.join(', '));
          "

      - name: Build CSS & verify
        run: |
          npm run build:css
          test -f public/css/style.css || { echo "‚ùå CSS build missing"; exit 1; }
          echo "‚úÖ Build artifacts verified"

      - name: Dry-run pack
        run: |
          npm pack --dry-run 2>&1 | tee pack-output.txt
          echo "## üìã Package Contents" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat pack-output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # ‚îÄ‚îÄ‚îÄ Job 2: Publish (after checks pass) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  publish:
    needs: [check]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build CSS
        run: npm run build:css

      - name: Detect version and bump
        id: version
        run: |
          CURRENT=$(node -p "require('./package.json').version")
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          # Determine bump type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BUMP="${{ github.event.inputs.bump }}"
          elif [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            NEW_VERSION="${TAG#v}"
            echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "üì¶ Release version: $NEW_VERSION"
            exit 0
          else
            # Auto-detect from commit messages
            COMMITS=$(git log --oneline -10 --format="%s")
            if echo "$COMMITS" | grep -qiE "^(BREAKING|feat!|fix!|refactor!)"; then
              BUMP="major"
            elif echo "$COMMITS" | grep -qiE "^feat"; then
              BUMP="minor"
            else
              BUMP="patch"
            fi
          fi

          echo "bump=$BUMP" >> $GITHUB_OUTPUT

          # Calculate new version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
          case "$BUMP" in
            major) NEW_VERSION="$((MAJOR+1)).0.0" ;;
            minor) NEW_VERSION="$MAJOR.$((MINOR+1)).0" ;;
            patch) NEW_VERSION="$MAJOR.$MINOR.$((PATCH+1))" ;;
          esac

          echo "new=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bumped=true" >> $GITHUB_OUTPUT
          echo "üì¶ Version bump: $CURRENT ‚Üí $NEW_VERSION ($BUMP)"

      - name: Check if version already published
        id: check
        run: |
          NEW="${{ steps.version.outputs.new }}"
          if npm view "commons-proxy@$NEW" version 2>/dev/null; then
            echo "‚ö†Ô∏è Version $NEW already published ‚Äî skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Version $NEW is available for publishing"
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Update package.json version
        if: steps.check.outputs.skip != 'true'
        run: |
          npm version "${{ steps.version.outputs.new }}" --no-git-tag-version --allow-same-version
          echo "‚úÖ $(node -p "JSON.parse(require('fs').readFileSync('package.json','utf8')).version")"

      - name: Publish to npm
        if: steps.check.outputs.skip != 'true'
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Tag and push version commit
        if: steps.check.outputs.skip != 'true' && github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: release v${{ steps.version.outputs.new }} [skip ci]" || true
          git tag "v${{ steps.version.outputs.new }}"
          git push origin main --tags || true

      - name: Publish summary
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "## üöÄ Published to npm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package**: \`commons-proxy@${{ steps.version.outputs.new }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Previous**: \`${{ steps.version.outputs.current }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "npm install -g commons-proxy@${{ steps.version.outputs.new }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[![npm version](https://img.shields.io/npm/v/commons-proxy.svg)](https://www.npmjs.com/package/commons-proxy)" >> $GITHUB_STEP_SUMMARY

      - name: Skipped summary
        if: steps.check.outputs.skip == 'true'
        run: |
          echo "## ‚è≠Ô∏è Publish Skipped" >> $GITHUB_STEP_SUMMARY
          echo "Version \`${{ steps.version.outputs.new }}\` is already published on npm." >> $GITHUB_STEP_SUMMARY

      - name: Add npm badge to release notes
        if: github.event_name == 'release' && steps.check.outputs.skip != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id
            });
            const npmBadge = `\n\n---\n\n## üì¶ Installation\n\n\`\`\`bash\nnpm install -g commons-proxy@${{ steps.version.outputs.new }}\n\`\`\`\n\n[![npm version](https://img.shields.io/npm/v/commons-proxy.svg)](https://www.npmjs.com/package/commons-proxy)\n[![npm downloads](https://img.shields.io/npm/dm/commons-proxy.svg)](https://www.npmjs.com/package/commons-proxy)`;
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: context.payload.release.id,
              body: release.data.body + npmBadge
            });
